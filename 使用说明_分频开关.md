# 分频/不分频 快速切换说明

## 快速切换方法

只需修改 `dl_anc_multiband.py` 文件的 **第45行**：

```python
USE_MULTIBAND = True   # True=分频训练, False=不分频
```

---

## 两种模式对比

### 模式1：分频训练（推荐）⭐

**设置：**
```python
USE_MULTIBAND = True
```

**效果：**
- 训练 **3个模型**（低、中、高频段各一个）
- 每个频段使用不同的训练配置
- 融合三个频段的预测结果

**频段划分：**
- 低频：20-150Hz (stride=2, epochs=400, hidden_size=384)
- 中频：150-250Hz (stride=2, epochs=400, hidden_size=384)
- 高频：250-500Hz (stride=1, epochs=600, hidden_size=640)

**优点：**
- ✅ 每个频段都得到充分优化
- ✅ 避免低频主导训练
- ✅ 高频段可以使用更激进的训练参数
- ✅ 效果最好（已达到-10 dB）

**缺点：**
- ⚠️ 训练时间较长（需要训练3个模型）
- ⚠️ 模型参数量较大（总计约9.4M参数）

**预计训练时间：** 1-3小时

**预期效果：** -10 dB（已验证）

---

### 模式2：不分频（全频段）

**设置：**
```python
USE_MULTIBAND = False
```

**效果：**
- 训练 **1个模型**（全频段20-500Hz）
- 使用统一的训练配置
- 直接输出预测结果（无需融合）

**训练配置：**
- 全频段：20-500Hz (stride=1, epochs=500, hidden_size=512)

**优点：**
- ✅ 训练时间较短（只训练1个模型）
- ✅ 模型参数量较小（约5.2M参数）
- ✅ 部署简单（只需一个模型）

**缺点：**
- ⚠️ 低频可能主导训练
- ⚠️ 高频拟合可能不够好
- ⚠️ 无法针对不同频段优化

**预计训练时间：** 30-60分钟

**预期效果：** -7到-8 dB（预测）

---

## 使用建议

### 推荐流程

1. **首次测试**：使用 `USE_MULTIBAND = False`
   - 快速验证模型是否能工作
   - 了解全频段的基础性能
   - 预计30-60分钟

2. **性能优化**：使用 `USE_MULTIBAND = True`
   - 追求最佳性能
   - 确保所有频段都拟合好
   - 预计1-3小时

3. **对比分析**：
   - 对比两种模式的ANC降噪量
   - 查看PSD图，对比各频段拟合质量
   - 决定最终使用哪种模式

---

## 完整操作步骤

### 测试不分频模式

1. 打开 `dl_anc_multiband.py`
2. 修改第45行：
   ```python
   USE_MULTIBAND = False
   ```
3. 保存文件
4. 运行：
   ```bash
   python dl_anc_multiband.py
   ```
5. 查看结果：
   - 控制台输出的ANC降噪量
   - `results/multiband_anc_result.png` 图表
   - `results/multiband_psd_only.png` PSD对比图

### 恢复分频模式

1. 打开 `dl_anc_multiband.py`
2. 修改第45行：
   ```python
   USE_MULTIBAND = True
   ```
3. 保存文件
4. 运行：
   ```bash
   python dl_anc_multiband.py
   ```

---

## 输出文件说明

### 分频模式输出

```
results/
├── multiband_model_low.pth      # 低频段模型
├── multiband_model_mid.pth      # 中频段模型
├── multiband_model_high.pth     # 高频段模型
├── multiband_anc_result.png     # 完整结果图（4行×3列）
├── multiband_psd_only.png       # 单独PSD对比图
└── multiband_results.npy        # 数值结果
```

### 不分频模式输出

```
results/
├── multiband_model_full.pth     # 全频段模型
├── multiband_anc_result.png     # 完整结果图（简化版）
├── multiband_psd_only.png       # 单独PSD对比图
└── multiband_results.npy        # 数值结果
```

---

## 性能对比（预测）

| 指标 | 分频模式 | 不分频模式 |
|------|---------|-----------|
| **ANC降噪量** | **-10 dB** ✅ | -7到-8 dB |
| **低频拟合** | 很好 ✅ | 很好 ✅ |
| **中频拟合** | 很好 ✅ | 较好 ⚠️ |
| **高频拟合** | 很好 ✅ | 一般 ⚠️ |
| **训练时间** | 1-3小时 | 30-60分钟 ✅ |
| **模型参数** | 9.4M | 5.2M ✅ |
| **部署复杂度** | 需要3个模型 | 只需1个模型 ✅ |

---

## 常见问题

### Q1: 为什么分频效果更好？

**A:** 主要原因：
1. 能量平衡：每个频段单独归一化，避免低频主导
2. 针对性优化：高频段可以使用更激进的训练参数
3. 专注学习：每个模型只需学习自己频段的特征

### Q2: 不分频能达到-10 dB吗？

**A:** 理论上可能，但实际困难：
- 模型有频域路径，理论上能处理所有频率
- 但训练时低频能量高，梯度会被低频主导
- 需要非常仔细的调参才可能达到

### Q3: 如何选择？

**A:** 根据需求：
- **追求性能**：用分频模式（已验证-10 dB）
- **快速测试**：用不分频模式
- **实际部署**：如果-7到-8 dB够用，不分频更简单

### Q4: 可以自定义频段划分吗？

**A:** 可以！修改第235-239行：
```python
frequency_bands = {
    'low': (20, 100),      # 自定义低频范围
    'mid': (100, 300),     # 自定义中频范围
    'high': (300, 500)     # 自定义高频范围
}
```

同时需要修改第257-279行的训练配置。

---

## 总结

**一行代码切换：**
```python
USE_MULTIBAND = True   # 分频（推荐，-10 dB）
USE_MULTIBAND = False  # 不分频（快速测试）
```

**建议：**
1. 先用 `False` 快速测试（30-60分钟）
2. 再用 `True` 追求最佳性能（1-3小时）
3. 对比两种模式的效果
4. 根据实际需求选择最终方案

**当前已验证：**
- ✅ 分频模式：-10 dB（超过维纳滤波器的-7.65 dB）
- ⏳ 不分频模式：待测试

祝实验顺利！🎉
